<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Easy Gift ‚Äî –∫–µ–π—Å—ã, –ø—Ä–æ—Ñ–∏–ª—å, 24—á</title>

  <!-- Telegram Mini App SDK (–µ—Å–ª–∏ –æ—Ç–∫—Ä–æ—é—Ç –≤ Telegram) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0f1720;
      --text:#e7eef7;
      --muted:#93a6bd;
      --accent:#33a6ff;
      --good:#17c964;
      --warn:#f5a524;
      --danger:#ff4d4d;
      --radius:16px;

      --itemW: 150px;
      --itemH: 120px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg,#0b121a, #0f1720 40%, #0b121a);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      padding:16px;
    }
    .app{max-width:980px;margin:0 auto;display:flex;flex-direction:column;gap:12px;}

    .topbar{
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:var(--radius);
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    /* ‚úÖ –¥–æ–±–∞–≤–∏–ª –∞–≤–∞—Ç–∞—Ä+–Ω–∏–∫ —Å–ª–µ–≤–∞, –Ω–æ –æ–±—â–∏–π —Å—Ç–∏–ª—å –ù–ï –ª–æ–º–∞–ª */
    .topLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .avatar{
      width:42px;height:42px;
      border-radius:50%;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      overflow:hidden;
      flex:0 0 auto;
      display:grid;
      place-items:center;
      color:var(--muted);
      font-weight:900;
      user-select:none;
    }
    .avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .title{display:flex;flex-direction:column;gap:2px;line-height:1.1;min-width:0;}
    .title b{font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .title small{color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;}
    .pill{
      padding:8px 10px;
      border-radius:999px;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.08);
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      font-weight:900;
    }
    .starImg{
      width:18px;height:18px;object-fit:contain;display:block;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,.35));
    }
    .btn{
      border:0;
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      background:var(--accent);
      color:#06121b;
      cursor:pointer;
      user-select:none;
      touch-action:manipulation;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed;}
    .btn.secondary{
      background:rgba(255,255,255,0.08);
      color:var(--text);
      border:1px solid rgba(255,255,255,0.12);
    }
    .btn.danger{
      background:rgba(255,77,77,0.18);
      color:var(--text);
      border:1px solid rgba(255,77,77,0.35);
    }

    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:999px;
      padding:6px;
      width:fit-content;
    }
    .tab{
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      color:var(--muted);
      user-select:none;
    }
    .tab.active{
      background:rgba(51,166,255,0.18);
      border:1px solid rgba(51,166,255,0.35);
      color:var(--text);
    }

    .card{
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:var(--radius);
      padding:12px;
    }
    .card h3{
      margin:0 0 10px 0;
      font-size:14px;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.2px;
      text-transform:uppercase;
    }

    /* –ö–µ–π—Å—ã */
    .casesRow{
      display:flex;
      gap:10px;
      overflow:auto;
      padding-bottom:6px;
      -webkit-overflow-scrolling:touch;
      scroll-snap-type:x mandatory;
    }
    .caseCard{
      flex:0 0 240px;
      scroll-snap-align:start;
      border-radius:18px;
      background:rgba(0,0,0,0.16);
      border:1px solid rgba(255,255,255,0.10);
      padding:12px;
      display:flex;
      gap:12px;
      align-items:center;
      cursor:pointer;
      user-select:none;
    }
    .caseCard.active{
      border-color:rgba(51,166,255,0.7);
      box-shadow:0 0 0 4px rgba(51,166,255,0.10);
    }
    .caseArt{
      width:64px;height:64px;
      border-radius:16px;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      display:grid;place-items:center;
      font-size:28px;
      flex:0 0 auto;
    }
    .caseInfo{min-width:0;display:flex;flex-direction:column;gap:4px;}
    .caseName{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    /* ‚úÖ caseSub –æ—Å—Ç–∞–≤–ª—è—é –≤ CSS, –Ω–æ –≤ HTML –±–æ–ª—å—à–µ –ù–ï –≤—ã–≤–æ–∂—É (–æ–ø–∏—Å–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ) */
    .caseSub{color:var(--muted);font-size:12px;line-height:1.2;}
    .priceLine{display:flex;align-items:center;gap:6px;font-weight:900;}
    .priceLine small{color:var(--muted);font-weight:700}

    /* –†—É–ª–µ—Ç–∫–∞ */
    .rouletteWrap{display:flex;flex-direction:column;gap:10px;}
    .window{
      position:relative;
      height: var(--itemH);
      overflow:hidden;
      border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.08);
    }
    .fadeLeft, .fadeRight{
      position:absolute;top:0;bottom:0;width:44px;z-index:3;pointer-events:none;
    }
    .fadeLeft{left:0;background:linear-gradient(90deg, rgba(15,23,32,1), rgba(15,23,32,0));}
    .fadeRight{right:0;background:linear-gradient(270deg, rgba(15,23,32,1), rgba(15,23,32,0));}
    .centerLine{
      position:absolute;top:0;bottom:0;left:50%;
      width:2px;background:rgba(51,166,255,.35);z-index:2;
    }
    .pointer{
      position:absolute;
      left:50%;
      top:6px;
      transform:translateX(-50%);
      width:0;height:0;
      border-left:12px solid transparent;
      border-right:12px solid transparent;
      border-top:16px solid rgba(51,166,255,.95);
      z-index:4;
      filter:drop-shadow(0 6px 10px rgba(0,0,0,.35));
    }
    .track{
      position:absolute;
      top:0;left:0;height:100%;
      display:flex;
      will-change:transform;
      transform:translateX(0px);
      z-index:1;
    }
    .item{
      width:var(--itemW);
      height:var(--itemH);
      padding:10px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:8px;
      border-right:1px solid rgba(255,255,255,0.06);
      background:rgba(0,0,0,0.03);
    }
    .item:nth-child(2n){ background:rgba(255,255,255,0.02); }
    .itemEmoji{
      width:54px;height:54px;
      border-radius:18px;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      display:grid;place-items:center;
      font-size:30px;
    }
    .itemName{
      font-weight:900;
      font-size:13px;
      text-align:center;
      line-height:1.15;
      padding:0 4px;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-height:30px;
    }
    .itemCost{
      display:flex;align-items:center;gap:6px;
      font-weight:900;
    }
    .badge{
      font-size:12px;
      color:var(--muted);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.04);
    }
    .controls{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;
    }
    .hint{color:var(--muted);font-size:12px;line-height:1.3;}
    .result{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(0,0,0,0.18);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .result b{font-size:14px}

    /* –ü—Ä–æ—Ñ–∏–ª—å */
    .profileHeader{
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .userBox{display:flex;flex-direction:column;gap:2px;}
    .userBox b{font-size:15px}
    .invList{display:flex;flex-direction:column;gap:8px;margin-top:10px;}
    .invItem{
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(0,0,0,0.16);
      padding:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .invLeft{display:flex;gap:10px;align-items:center;min-width:0;}
    .miniEmoji{
      width:38px;height:38px;border-radius:14px;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      display:grid;place-items:center;
      font-size:20px;
      flex:0 0 auto;
    }
    .invName{
      font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      max-width:55vw;
    }
    .invMeta{color:var(--muted);font-size:12px;margin-top:2px;}
    .invRight{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end;}
    .smallPrice{
      display:flex;align-items:center;gap:6px;font-weight:900;
      white-space:nowrap;
    }
    .empty{
      padding:14px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,0.15);
      color:var(--muted);
      text-align:center;
      margin-top:10px;
    }

    /* –ú–æ–¥–∞–ª–∫–∞ "–æ—Å—Ç–∞–≤–∏—Ç—å/–ø—Ä–æ–¥–∞—Ç—å" */
    .modalBack{
      position:fixed;inset:0;
      background:rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .modal{
      width:min(520px, 100%);
      border-radius:18px;
      background:rgba(15,23,32,0.96);
      border:1px solid rgba(255,255,255,0.10);
      box-shadow:0 20px 60px rgba(0,0,0,0.4);
      padding:14px;
    }
    .modalTop{display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .modalTop b{font-size:16px}
    .closeX{cursor:pointer;color:var(--muted);font-weight:900;padding:6px 10px;border-radius:12px;}
    .closeX:hover{background:rgba(255,255,255,0.06);color:var(--text);}
    .modalBody{margin-top:10px;display:flex;gap:12px;align-items:center;}
    .bigEmoji{
      width:74px;height:74px;border-radius:22px;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      display:grid;place-items:center;font-size:40px;flex:0 0 auto;
    }
    .modalActions{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <!-- ‚úÖ –ª–µ–≤—ã–π –±–ª–æ–∫: –∞–≤–∞—Ç–∞—Ä + –∑–∞–≥–æ–ª–æ–≤–æ–∫/–Ω–∏–∫ -->
      <div class="topLeft">
        <div class="avatar" id="avatar">
          <span id="avatarFallback">EG</span>
        </div>

        <div class="title">
          <b>Easy Gift ‚Äî Mini App ‚Ä¢ 24—á ‚Ä¢ –ü—Ä–æ—Ñ–∏–ª—å</b>
          <small id="subTitle">–ü–æ–¥–∫–ª—é—á–∞–µ–º Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</small>
        </div>
      </div>

      <div class="row">
        <div class="pill" title="–ë–∞–ª–∞–Ω—Å –∑–≤—ë–∑–¥">
          <img class="starImg" src="img/Star.png" alt="‚≠ê" onerror="this.style.display='none'">
          <span id="stars">0</span>
        </div>
        <!-- ‚úÖ –∞–Ω—Ç–∏—á–∏—Ç: –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω -->
        <button class="btn secondary" id="addStarsBtn">+ ‚≠ê</button>
      </div>
    </div>

    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="main">–ì–ª–∞–≤–Ω–∞—è</div>
      <div class="tab" data-tab="profile">–ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>

    <!-- MAIN -->
    <div id="tab_main" class="tabPage">
      <div class="card">
        <h3>–ö–µ–π—Å—ã</h3>
        <div class="casesRow" id="casesRow"></div>
        <!-- ‚úÖ —É–±—Ä–∞–ª –æ–ø–∏—Å–∞–Ω–∏–µ/–ø–æ–¥—Å–∫–∞–∑–∫—É –ø–æ–¥ –∫–µ–π—Å–∞–º–∏ -->
      </div>

      <div class="card rouletteWrap">
        <h3>–†—É–ª–µ—Ç–∫–∞ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ)</h3>

        <div class="window" id="window">
          <div class="fadeLeft"></div>
          <div class="fadeRight"></div>
          <div class="centerLine"></div>
          <div class="pointer"></div>
          <div class="track" id="track"></div>
        </div>

        <div class="controls">
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
            <span class="badge" id="caseBadge">–ö–µ–π—Å: ‚Äî</span>
            <span class="badge" id="cooldownBadge">–î–æ—Å—Ç—É–ø–Ω–æ</span>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn secondary" id="demoBtn" title="–î–µ–º–æ –Ω–µ —Ç—Ä–∞—Ç–∏—Ç –∑–≤—ë–∑–¥—ã, –Ω–æ –ù–ï —Å—Ç–∞–≤–∏—Ç –∫–¥">–î–µ–º–æ</button>
            <button class="btn" id="spinBtn">–ò—Å–ø—ã—Ç–∞–π —É–¥–∞—á—É</button>
          </div>
        </div>

        <div class="result">
          <div>
            <div class="hint">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
            <b id="resultText">–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ</b>
          </div>
          <div class="hint" id="resultMeta"></div>
        </div>
      </div>
    </div>

    <!-- PROFILE -->
    <div id="tab_profile" class="tabPage" style="display:none;">
      <div class="card">
        <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>

        <div class="profileHeader">
          <div class="userBox">
            <b id="userName">‚Äî</b>
            <div class="hint" id="userIdLine">‚Äî</div>
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
            <button class="btn secondary" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
            <button class="btn danger" id="wipeBtn">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å (–ª–æ–∫–∞–ª—å–Ω–æ)</button>
          </div>
        </div>

        <div class="hint" style="margin-top:8px;">
          –ó–¥–µ—Å—å —Ö—Ä–∞–Ω—è—Ç—Å—è ‚Äú–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ‚Äù –ø–æ–¥–∞—Ä–∫–∏. –ú–æ–∂–Ω–æ –ø—Ä–æ–¥–∞—Ç—å –∏—Ö –∑–∞ ‚≠ê.
        </div>

        <div id="invWrap"></div>

        <!-- ‚úÖ –º–∏–Ω–∏-–∞–¥–º–∏–Ω –±–ª–æ–∫ (–≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ @RealZanT), –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∏–∑–∞–π–Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
        <div id="adminBlock" style="display:none;margin-top:12px;">
          <div class="hint" style="margin-bottom:8px;">–ê–¥–º–∏–Ω: @RealZanT</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
            <button class="btn secondary" id="adminAdd100">+100 ‚≠ê</button>
            <button class="btn secondary" id="adminResetCd">–°–±—Ä–æ—Å–∏—Ç—å –ö–î</button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- MODAL keep/sell -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalTop">
        <b>–í—ã–ø–∞–ª –ø–æ–¥–∞—Ä–æ–∫</b>
        <div class="closeX" id="modalClose">‚úï</div>
      </div>

      <div class="modalBody">
        <div class="bigEmoji" id="modalEmoji">üéÅ</div>
        <div style="min-width:0;">
          <div style="font-weight:900;font-size:14px;" id="modalName">‚Äî</div>
          <div class="hint" id="modalInfo">‚Äî</div>
          <div style="margin-top:8px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <div class="smallPrice">
              <img class="starImg" src="img/Star.png" alt="‚≠ê" onerror="this.style.display='none'">
              <span id="modalCost">0</span>
              <span class="hint">—Å—Ç–æ–∏–º–æ—Å—Ç—å (gift)</span>
            </div>
            <div class="smallPrice">
              <img class="starImg" src="img/Star.png" alt="‚≠ê" onerror="this.style.display='none'">
              <span id="modalSell">0</span>
              <span class="hint">–∑–∞ –ø—Ä–æ–¥–∞–∂—É</span>
            </div>
          </div>
        </div>
      </div>

      <div class="modalActions">
        <button class="btn secondary" id="keepBtn">–û—Å—Ç–∞–≤–∏—Ç—å</button>
        <button class="btn" id="sellBtn">–ü—Ä–æ–¥–∞—Ç—å –∑–∞ ‚≠ê</button>
      </div>
    </div>
  </div>

<script>
/* ==========================
   –ù–ê–°–¢–†–û–ô–ö–ò
========================== */
const COOLDOWN_MS = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞
const SELL_RATE = 0.20; // 20%

/* ‚úÖ –ê–¥–º–∏–Ω */
const ADMIN_USERNAME = "@RealZanT";

/* –ö–µ–π—Å—ã –∏ –ø—Ä–∏–∑—ã */
const CASES = [
  {
    id: "case_1",
    icon: "üéÅ",
    name: "–ö–µ–π—Å –∑–∞ 1‚≠ê",
    price: 1,
    note: "–î–µ—à—ë–≤–æ–µ —á–∞—Å—Ç–æ. 1‚≠ê –≤—ã–ø–∞–¥–∞–µ—Ç –æ—á–µ–Ω—å —á–∞—Å—Ç–æ.", // (‚úÖ –æ–ø–∏—Å–∞–Ω–∏–µ –±–æ–ª—å—à–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º)
    gifts: [
      /* ‚úÖ –±—ã–ª–æ 1 –∑–≤–µ–∑–¥–∞ -> —Å—Ç–∞–ª–æ 2 –∑–≤–µ–∑–¥—ã */
      {id:"g_star2", emoji:"‚≠ê", name:"2 –∑–≤–µ–∑–¥—ã", cost:2,  weight:70, isStars:true},
      {id:"g_heart", emoji:"üíù", name:"–°–µ—Ä–¥—Ü–µ",  cost:15, weight:30},
      {id:"g_lolli", emoji:"üç≠", name:"–õ–µ–¥–µ–Ω–µ—Ü", cost:560, weight:16},
      {id:"g_flwr",  emoji:"üå∏", name:"–¶–≤–µ—Ç–æ–∫",  cost:1280, weight:10},
      {id:"g_cake",  emoji:"üç∞", name:"–¢–æ—Ä—Ç",    cost:780, weight:12},
      {id:"g_potion",emoji:"üß™", name:"–ó–µ–ª—å–µ",   cost:2300, weight:4},
    ]
  },
  {
    id: "case_5",
    icon: "üß∏",
    name: "–ö–µ–π—Å –∑–∞ 5‚≠ê",
    price: 5,
    note: "–°—Ä–µ–¥–Ω–∏–µ –ø—Ä–∏–∑—ã",
    gifts: [
      {id:"g_cake2", emoji:"üç∞", name:"–¢–æ—Ä—Ç —Å –≤–∏—à–Ω–µ–π", cost:780,  weight:18},
      {id:"g_flwr2", emoji:"üå∏", name:"–¶–≤–µ—Ç–æ–∫",       cost:1280, weight:16},
      {id:"g_shoe",  emoji:"üë†", name:"–¢—É—Ñ–ª–∏",        cost:1750, weight:12},
      {id:"g_potion2",emoji:"üß™",name:"–ó–µ–ª—å–µ",        cost:2300, weight:10},
      {id:"g_rose",  emoji:"üåπ", name:"–†–æ–∑–∞ –≤ –∫–æ–ª–±–µ", cost:3500, weight:6},
      {id:"g_ring",  emoji:"üíç", name:"–ö–æ–ª—å—Ü–æ",       cost:3900, weight:4},
    ]
  },
  {
    id: "case_40",
    icon: "üíù",
    name: "–ö–µ–π—Å –∑–∞ 40‚≠ê",
    price: 40,
    note: "–¢–æ–ø –ø—Ä–∏–∑—ã —á–∞—â–µ, —á–µ–º –≤ –¥–µ—à—ë–≤—ã—Ö",
    gifts: [
      {id:"g_bear",  emoji:"üß∏", name:"–ú–∏—à–∫–∞",        cost:5500, weight:6},
      {id:"g_ring2", emoji:"üíç", name:"–ö–æ–ª—å—Ü–æ",       cost:3900, weight:10},
      {id:"g_rose2", emoji:"üåπ", name:"–†–æ–∑–∞ –≤ –∫–æ–ª–±–µ", cost:3500, weight:10},
      {id:"g_shoe2", emoji:"üë†", name:"–¢—É—Ñ–ª–∏",        cost:1750, weight:18},
      {id:"g_flwr3", emoji:"üå∏", name:"–¶–≤–µ—Ç–æ–∫",       cost:1280, weight:22},
      {id:"g_lolli2",emoji:"üç≠", name:"–õ–µ–¥–µ–Ω–µ—Ü",      cost:560,  weight:26},
    ]
  }
];

/* ==========================
   –ü–ï–†–°–ò–°–¢–ï–ù–¢–ù–û–°–¢–¨ / USER
========================== */
function safeJsonParse(s, fallback){
  try { return JSON.parse(s); } catch { return fallback; }
}
function nowMs(){ return Date.now(); }
function fmtTimeLeft(ms){
  ms = Math.max(0, ms);
  const totalSec = Math.floor(ms/1000);
  const h = Math.floor(totalSec/3600);
  const m = Math.floor((totalSec%3600)/60);
  const s = totalSec%60;
  const pad = (x)=>String(x).padStart(2,"0");
  return `${pad(h)}:${pad(m)}:${pad(s)}`;
}

function getTelegramUser(){
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  if (!tg) return null;
  const u = tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;
  if (!u || !u.id) return null;

  try { tg.expand(); } catch {}

  return {
    id: String(u.id),
    username: u.username ? "@"+u.username : "",
    first_name: u.first_name || "",
    last_name: u.last_name || "",
    photo_url: u.photo_url || ""
  };
}

function ensureGuestUser(){
  const key = "eg_guest_id";
  let id = localStorage.getItem(key);
  if (!id){
    id = "guest_" + Math.random().toString(16).slice(2) + "_" + Date.now();
    localStorage.setItem(key, id);
  }
  return { id, username:"", first_name:"–ì–æ—Å—Ç—å", last_name:"", photo_url:"" };
}

let USER = null;
let IS_ADMIN = false;

function initUser(){
  const tgUser = getTelegramUser();
  USER = tgUser ? tgUser : ensureGuestUser();

  IS_ADMIN = (USER.username === ADMIN_USERNAME);

  const name = [USER.first_name, USER.last_name].filter(Boolean).join(" ").trim() || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
  const nick = USER.username ? USER.username : "";
  const sub = tgUser
    ? `Telegram: ${nick || name}`.trim()
    : `–í—Ö–æ–¥: –õ–æ–∫–∞–ª—å–Ω—ã–π –≥–æ—Å—Ç—å (–≤–Ω–µ Telegram)`;

  document.getElementById("subTitle").textContent = sub;
  document.getElementById("userName").textContent = `${name} ${nick}`.trim();
  document.getElementById("userIdLine").textContent = `ID: ${USER.id}`;

  /* ‚úÖ –ø—Ä–µ–≤—å—é (–∞–≤–∞—Ç–∞—Ä) —Å–≤–µ—Ä—Ö—É */
  const avatar = document.getElementById("avatar");
  const fallback = document.getElementById("avatarFallback");
  if (USER.photo_url){
    fallback.style.display = "none";
    avatar.innerHTML = `<img src="${escapeHtml(USER.photo_url)}" alt="avatar">`;
  } else {
    fallback.textContent = (nick || name || "EG").replace("@","").slice(0,2).toUpperCase();
  }

  /* ‚úÖ –∞–¥–º–∏–Ω –±–ª–æ–∫ –≤ –ø—Ä–æ—Ñ–∏–ª–µ */
  const adminBlock = document.getElementById("adminBlock");
  if (adminBlock) adminBlock.style.display = IS_ADMIN ? "" : "none";

  /* ‚úÖ –µ—Å–ª–∏ –Ω–µ –∞–¥–º–∏–Ω ‚Äî –∫–Ω–æ–ø–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç */
  const addBtn = document.getElementById("addStarsBtn");
  if (addBtn){
    if (!IS_ADMIN){
      addBtn.textContent = "+ ‚≠ê";
      addBtn.title = "–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ";
    } else {
      addBtn.title = "–ê–¥–º–∏–Ω –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ";
    }
  }

  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  if (tg){
    try { tg.setHeaderColor("#0f1720"); } catch {}
    try { tg.setBackgroundColor("#0f1720"); } catch {}
  }
}

/* –∫–ª—é—á–∏ –ø–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
function kBalance(){ return `eg_balance_${USER.id}`; }
function kInv(){ return `eg_inventory_${USER.id}`; }
function kLastSpin(){ return `eg_lastSpin_${USER.id}`; }

/* ==========================
   –°–û–°–¢–û–Ø–ù–ò–ï
========================== */
const els = {
  stars: document.getElementById("stars"),
  addStarsBtn: document.getElementById("addStarsBtn"),
  casesRow: document.getElementById("casesRow"),
  caseBadge: document.getElementById("caseBadge"),
  cooldownBadge: document.getElementById("cooldownBadge"),
  track: document.getElementById("track"),
  window: document.getElementById("window"),
  spinBtn: document.getElementById("spinBtn"),
  demoBtn: document.getElementById("demoBtn"),
  resultText: document.getElementById("resultText"),
  resultMeta: document.getElementById("resultMeta"),
  invWrap: document.getElementById("invWrap"),
  exportBtn: document.getElementById("exportBtn"),
  wipeBtn: document.getElementById("wipeBtn"),

  modalBack: document.getElementById("modalBack"),
  modalClose: document.getElementById("modalClose"),
  modalEmoji: document.getElementById("modalEmoji"),
  modalName: document.getElementById("modalName"),
  modalInfo: document.getElementById("modalInfo"),
  modalCost: document.getElementById("modalCost"),
  modalSell: document.getElementById("modalSell"),
  keepBtn: document.getElementById("keepBtn"),
  sellBtn: document.getElementById("sellBtn"),

  adminAdd100: document.getElementById("adminAdd100"),
  adminResetCd: document.getElementById("adminResetCd"),
};

let stars = 0;
let inventory = [];
let activeCase = CASES[0];
let isSpinning = false;

let pendingGift = null;

/* ==========================
   STORAGE
========================== */
function loadAll(){
  const savedBal = Number(localStorage.getItem(kBalance()));
  /* ‚úÖ —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å = 1 */
  stars = Number.isFinite(savedBal) ? savedBal : 1;

  inventory = safeJsonParse(localStorage.getItem(kInv()), []);
  if (!Array.isArray(inventory)) inventory = [];

  updateStarsUI();
}

function saveBalance(){
  localStorage.setItem(kBalance(), String(stars));
}
function saveInventory(){
  localStorage.setItem(kInv(), JSON.stringify(inventory));
}

function updateStarsUI(){
  els.stars.textContent = String(stars);
}

/* ==========================
   UI ‚Äî tabs
========================== */
function setTab(name){
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.tab === name);
  });
  document.querySelectorAll(".tabPage").forEach(p=>p.style.display="none");
  document.getElementById("tab_"+name).style.display = "";
  if (name === "profile") renderInventory();
}
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=> setTab(t.dataset.tab));
});

/* ==========================
   –†–£–õ–ï–¢–ö–ê / –®–ê–ù–°
========================== */
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function weightedPick(list){
  const total = list.reduce((s,g)=>s + (g.weight || 1), 0);
  let r = Math.random() * total;
  for (let i=0;i<list.length;i++){
    r -= (list[i].weight || 1);
    if (r <= 0) return { gift:list[i], index:i };
  }
  return { gift:list[list.length-1], index:list.length-1 };
}

function buildTrack(baseGifts){
  const repeats = 18;
  const items = [];
  for (let r=0;r<repeats;r++){
    for (const g of baseGifts) items.push(g);
  }

  els.track.innerHTML = items.map(g => `
    <div class="item">
      <div class="itemEmoji">${escapeHtml(g.emoji)}</div>
      <div class="itemName">${escapeHtml(g.name)}</div>
      <div class="itemCost">
        <img class="starImg" src="img/Star.png" alt="‚≠ê" onerror="this.style.display='none'">
        <span>${g.cost}</span>
      </div>
    </div>
  `).join("");

  els.track.style.transform = "translateX(0px)";
  els.track.dataset.repeats = String(repeats);
}

function getCurrentTranslateX(){
  const tr = getComputedStyle(els.track).transform;
  if (!tr || tr === "none") return 0;
  const m = tr.match(/matrix\(([^)]+)\)/);
  if (!m) return 0;
  const parts = m[1].split(",").map(x => Number(x.trim()));
  return parts[4] || 0;
}
function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }
function animate(ms, step){
  return new Promise((resolve) => {
    const start = performance.now();
    function frame(now){
      const t = clamp((now - start) / ms, 0, 1);
      step(t);
      if (t < 1) requestAnimationFrame(frame);
      else resolve();
    }
    requestAnimationFrame(frame);
  });
}

/* ==========================
   24 –ß–ê–°–ê (Cooldown)
========================== */
function getLastSpinMs(){
  const v = Number(localStorage.getItem(kLastSpin()));
  return Number.isFinite(v) ? v : 0;
}
function setLastSpinMs(ms){
  localStorage.setItem(kLastSpin(), String(ms));
}
function getCooldownLeftMs(){
  const last = getLastSpinMs();
  if (!last) return 0;
  const left = (last + COOLDOWN_MS) - nowMs();
  return Math.max(0, left);
}
function canSpinNow(){
  return getCooldownLeftMs() <= 0;
}
function updateCooldownUI(){
  const left = getCooldownLeftMs();
  if (left <= 0){
    els.cooldownBadge.textContent = "–î–æ—Å—Ç—É–ø–Ω–æ";
    els.spinBtn.disabled = false;
    return;
  }
  els.cooldownBadge.textContent = `–ß–µ—Ä–µ–∑ ${fmtTimeLeft(left)}`;
  els.spinBtn.disabled = true;
}
setInterval(updateCooldownUI, 500);

/* ==========================
   –ö–µ–π—Å—ã (‚úÖ –±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è)
========================== */
function renderCases(){
  els.casesRow.innerHTML = CASES.map(c => `
    <div class="caseCard ${c.id === activeCase.id ? "active" : ""}" data-id="${c.id}">
      <div class="caseArt">${escapeHtml(c.icon)}</div>
      <div class="caseInfo">
        <div class="caseName">${escapeHtml(c.name)}</div>
        <!-- ‚úÖ —É–±—Ä–∞–ª caseSub (–æ–ø–∏—Å–∞–Ω–∏–µ) -->
        <div class="priceLine">
          <img class="starImg" src="img/Star.png" alt="‚≠ê" onerror="this.style.display='none'">
          <span>${c.price}</span>
          <small>–∑–∞ —Å–ø–∏–Ω</small>
        </div>
      </div>
    </div>
  `).join("");

  [...els.casesRow.querySelectorAll(".caseCard")].forEach(card=>{
    card.addEventListener("click", ()=>{
      const id = card.dataset.id;
      const found = CASES.find(x=>x.id===id);
      if (!found) return;
      activeCase = found;
      renderCases();
      refreshRoulette();
    });
  });
}

function refreshRoulette(){
  els.caseBadge.textContent = `–ö–µ–π—Å: ${activeCase.name} ‚Ä¢ —Ü–µ–Ω–∞ ${activeCase.price}`;
  els.spinBtn.innerHTML = `–ò—Å–ø—ã—Ç–∞–π —É–¥–∞—á—É ‚Äî <span style="display:inline-flex;align-items:center;gap:6px;vertical-align:middle;">
    <img class="starImg" src="img/Star.png" alt="‚≠ê" onerror="this.style.display='none'">
    ${activeCase.price}
  </span>`;
  buildTrack(activeCase.gifts);
  els.resultText.textContent = "–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ";
  els.resultMeta.textContent = "";
  updateCooldownUI();
}

/* ==========================
   –ú–æ–¥–∞–ª–∫–∞ ‚Äú–æ—Å—Ç–∞–≤–∏—Ç—å/–ø—Ä–æ–¥–∞—Ç—å‚Äù
========================== */
function openModal(gift, caseObj){
  pendingGift = { gift, caseObj };

  const sellValue = Math.max(1, Math.floor((gift.cost || 0) * SELL_RATE));
  els.modalEmoji.textContent = gift.emoji || "üéÅ";
  els.modalName.textContent = gift.name || "–ü–æ–¥–∞—Ä–æ–∫";
  els.modalInfo.textContent = `–ò–∑ –∫–µ–π—Å–∞: ${caseObj.name} ‚Ä¢ –ü—Ä–æ–¥–∞–∂–∞: ${Math.round(SELL_RATE*100)}% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏`;
  els.modalCost.textContent = String(gift.cost || 0);
  els.modalSell.textContent = String(sellValue);

  els.modalBack.style.display = "flex";
}
function closeModal(){
  els.modalBack.style.display = "none";
  pendingGift = null;
}
els.modalClose.addEventListener("click", closeModal);
els.modalBack.addEventListener("click", (e)=>{
  if (e.target === els.modalBack) closeModal();
});

/* ==========================
   –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å / –ø—Ä–æ—Ñ–∏–ª—å
========================== */
function addToInventory(gift, caseObj){
  const item = {
    uid: "inv_" + Math.random().toString(16).slice(2) + "_" + Date.now(),
    giftId: gift.id || "",
    emoji: gift.emoji || "üéÅ",
    name: gift.name || "–ü–æ–¥–∞—Ä–æ–∫",
    cost: Number(gift.cost || 0),
    fromCase: caseObj.name || "",
    ts: nowMs(),
  };
  inventory.unshift(item);
  saveInventory();
}

function sellItemValue(cost){
  return Math.max(1, Math.floor((Number(cost)||0) * SELL_RATE));
}

function renderInventory(){
  if (!inventory.length){
    els.invWrap.innerHTML = `<div class="empty">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç. –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ–π –ø–æ–¥–∞—Ä–æ–∫ –∏ –Ω–∞–∂–º–∏ ‚Äú–û—Å—Ç–∞–≤–∏—Ç—å‚Äù.</div>`;
    return;
  }

  els.invWrap.innerHTML = `
    <div class="invList">
      ${inventory.map(it => `
        <div class="invItem" data-uid="${escapeHtml(it.uid)}">
          <div class="invLeft">
            <div class="miniEmoji">${escapeHtml(it.emoji)}</div>
            <div style="min-width:0;">
              <div class="invName">${escapeHtml(it.name)}</div>
              <div class="invMeta">–ò–∑: ${escapeHtml(it.fromCase)} ‚Ä¢ ${new Date(it.ts).toLocaleString()}</div>
            </div>
          </div>

          <div class="invRight">
            <div class="smallPrice" title="–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–¥–∞—Ä–∫–∞">
              <img class="starImg" src="img/Star.png" alt="‚≠ê" onerror="this.style.display='none'">
              <span>${it.cost}</span>
            </div>
            <div class="smallPrice" title="–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏">
              <img class="starImg" src="img/Star.png" alt="‚≠ê" onerror="this.style.display='none'">
              <span>${sellItemValue(it.cost)}</span>
            </div>
            <button class="btn" data-sell="${escapeHtml(it.uid)}">–ü—Ä–æ–¥–∞—Ç—å</button>
          </div>
        </div>
      `).join("")}
    </div>
  `;

  els.invWrap.querySelectorAll("button[data-sell]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const uid = btn.getAttribute("data-sell");
      const idx = inventory.findIndex(x=>x.uid===uid);
      if (idx < 0) return;
      const it = inventory[idx];
      const gain = sellItemValue(it.cost);

      inventory.splice(idx, 1);
      saveInventory();
      stars += gain;
      saveBalance();
      updateStarsUI();
      renderInventory();
      alert(`–ü—Ä–æ–¥–∞–Ω–æ: +${gain} ‚≠ê`);
    });
  });
}

/* ==========================
   Spin
========================== */
async function spin({demo=false} = {}){
  if (isSpinning) return;

  if (!demo){
    if (!canSpinNow()){
      updateCooldownUI();
      return;
    }
    const price = Number(activeCase.price) || 0;
    if (stars < price){
      els.resultText.textContent = "–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∑–≤—ë–∑–¥";
      els.resultMeta.textContent = `–ù—É–∂–Ω–æ: ${price}`;
      return;
    }
  }

  isSpinning = true;
  els.spinBtn.disabled = true;
  els.demoBtn.disabled = true;

  if (!demo){
    const price = Number(activeCase.price) || 0;
    stars = stars - price;
    saveBalance();
    updateStarsUI();
  }

  const base = activeCase.gifts;
  const picked = weightedPick(base);
  const baseIndex = picked.index;

  const repeats = Number(els.track.dataset.repeats || 18);
  const targetRepeat = repeats - 3;
  const targetIndexLong = targetRepeat * base.length + baseIndex;

  const rect = els.window.getBoundingClientRect();
  const centerX = rect.width / 2;

  const ITEM_W = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--itemW')) || 150;
  const itemCenterX = targetIndexLong * ITEM_W + ITEM_W / 2;
  const targetTranslate = centerX - itemCenterX;

  const from = getCurrentTranslateX();
  const duration = 2400 + Math.random()*700;
  const jitter = (Math.random()*12) - 6;
  const finalTranslate = targetTranslate + jitter;

  await animate(duration, (t)=>{
    const eased = easeOutCubic(t);
    const x = from + (finalTranslate - from) * eased;
    els.track.style.transform = `translateX(${x}px)`;
  });

  els.track.style.transform = `translateX(${targetTranslate}px)`;

  els.resultText.textContent = `${picked.gift.emoji} ${picked.gift.name}`;
  els.resultMeta.textContent = demo ? "–¥–µ–º–æ" : "—Å–ø–∏–Ω";

  if (!demo){
    setLastSpinMs(nowMs());
    updateCooldownUI();

    /* ‚úÖ –µ—Å–ª–∏ –≤—ã–ø–∞–ª–∏ –∑–≤—ë–∑–¥—ã ‚Äî —Å—Ä–∞–∑—É –Ω–∞—á–∏—Å–ª—è–µ–º –Ω–∞ –±–∞–ª–∞–Ω—Å (–±–µ–∑ –º–æ–¥–∞–ª–∫–∏) */
    if (picked.gift && picked.gift.isStars){
      const gain = Math.max(1, Number(picked.gift.cost || 0));
      stars += gain;
      saveBalance();
      updateStarsUI();
      alert(`–í—ã–∏–≥—Ä—ã—à: +${gain} ‚≠ê`);
    } else {
      openModal(picked.gift, activeCase);
    }
  }

  isSpinning = false;
  els.demoBtn.disabled = false;
}

/* –∫–Ω–æ–ø–∫–∏ */
els.spinBtn.addEventListener("click", ()=> spin({demo:false}));
els.demoBtn.addEventListener("click", ()=> spin({demo:true}));

/* ‚úÖ –∞–Ω—Ç–∏—á–∏—Ç: –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω */
els.addStarsBtn.addEventListener("click", ()=>{
  if (!IS_ADMIN){
    alert("–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.");
    return;
  }
  const v = prompt("–°–∫–æ–ª—å–∫–æ –∑–≤—ë–∑–¥ –¥–æ–±–∞–≤–∏—Ç—å? (–∞–¥–º–∏–Ω)", "40");
  if (v === null) return;
  const n = Math.floor(Number(v));
  if (!Number.isFinite(n) || n <= 0) return;
  stars += n;
  saveBalance();
  updateStarsUI();
});

/* –ú–æ–¥–∞–ª–∫–∞: –æ—Å—Ç–∞–≤–∏—Ç—å/–ø—Ä–æ–¥–∞—Ç—å */
els.keepBtn.addEventListener("click", ()=>{
  if (!pendingGift) return;
  addToInventory(pendingGift.gift, pendingGift.caseObj);
  closeModal();
  alert("–ü–æ–¥–∞—Ä–æ–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –ø—Ä–æ—Ñ–∏–ª–µ ‚úÖ");
});
els.sellBtn.addEventListener("click", ()=>{
  if (!pendingGift) return;
  const gain = Math.max(1, Math.floor((pendingGift.gift.cost || 0) * SELL_RATE));
  stars += gain;
  saveBalance();
  updateStarsUI();
  closeModal();
  alert(`–ü—Ä–æ–¥–∞–Ω–æ: +${gain} ‚≠ê`);
});

/* –≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ—Ñ–∏–ª—è */
els.exportBtn.addEventListener("click", ()=>{
  const data = {
    user: USER,
    stars,
    inventory,
    lastSpinMs: getLastSpinMs(),
    exportedAt: new Date().toISOString()
  };
  const txt = JSON.stringify(data, null, 2);
  prompt("–°–∫–æ–ø–∏—Ä—É–π —ç–∫—Å–ø–æ—Ä—Ç JSON:", txt);
});

/* –°–±—Ä–æ—Å –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö */
els.wipeBtn.addEventListener("click", ()=>{
  const ok = confirm("–¢–æ—á–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å? (—É–¥–∞–ª–∏—Ç –∑–≤—ë–∑–¥—ã/–∏–Ω–≤–µ–Ω—Ç–∞—Ä—å/–∫–¥ –ª–æ–∫–∞–ª—å–Ω–æ)");
  if (!ok) return;
  localStorage.removeItem(kBalance());
  localStorage.removeItem(kInv());
  localStorage.removeItem(kLastSpin());
  loadAll();
  renderInventory();
  updateCooldownUI();
  alert("–°–±—Ä–æ—à–µ–Ω–æ.");
});

/* ‚úÖ –∞–¥–º–∏–Ω –∫–Ω–æ–ø–∫–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ */
if (els.adminAdd100){
  els.adminAdd100.addEventListener("click", ()=>{
    if (!IS_ADMIN) return;
    stars += 100;
    saveBalance();
    updateStarsUI();
    alert("+100 ‚≠ê");
  });
}
if (els.adminResetCd){
  els.adminResetCd.addEventListener("click", ()=>{
    if (!IS_ADMIN) return;
    setLastSpinMs(0);
    updateCooldownUI();
    alert("–ö–î —Å–±—Ä–æ—à–µ–Ω ‚úÖ");
  });
}

/* ==========================
   INIT
========================== */
initUser();
loadAll();
renderCases();
refreshRoulette();
updateCooldownUI();
renderInventory();

</script>
</body>
</html>
