<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Easy Gift</title>

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg0:#070c12;
      --bg1:#0b121a;
      --bg2:#0f1720;

      --text:#e7eef7;
      --muted:#93a6bd;
      --accent:#33a6ff;
      --accent2:#7c4dff;
      --good:#17c964;
      --warn:#f5a524;
      --danger:#ff4d4d;

      --radius:18px;

      --itemW: 150px;
      --itemH: 120px;

      --card: rgba(255,255,255,0.035);
      --border: rgba(255,255,255,0.07);
      --border2: rgba(255,255,255,0.10);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(51,166,255,.18), transparent 60%),
        radial-gradient(900px 600px at 90% 0%, rgba(124,77,255,.14), transparent 55%),
        radial-gradient(900px 700px at 80% 110%, rgba(51,166,255,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg2) 45%, var(--bg1));
      padding:14px;
      padding-bottom:86px; /* –º–µ—Å—Ç–æ –ø–æ–¥ –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é */
      overflow-x:hidden;
    }

    /* ====== –ú–ù–û–ì–û –î–ï–ö–û–†–ê ====== */
    .bgDecor{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:-1;
      overflow:hidden;
    }
    .blob{
      position:absolute;
      width:520px; height:520px;
      border-radius:50%;
      filter: blur(35px);
      opacity:.22;
      animation: floaty 12s ease-in-out infinite;
      transform: translate3d(0,0,0);
    }
    .blob.b1{ left:-180px; top:-220px; background: radial-gradient(circle at 30% 30%, rgba(51,166,255,.9), rgba(51,166,255,0) 60%); }
    .blob.b2{ right:-220px; top:-180px; background: radial-gradient(circle at 35% 35%, rgba(124,77,255,.9), rgba(124,77,255,0) 60%); animation-duration: 14s; }
    .blob.b3{ left:10%; bottom:-300px; width:640px;height:640px; background: radial-gradient(circle at 30% 30%, rgba(51,166,255,.7), rgba(51,166,255,0) 62%); animation-duration: 16s; opacity:.16; }
    @keyframes floaty{
      0%,100%{ transform: translate(0,0) scale(1); }
      50%{ transform: translate(18px, -14px) scale(1.03); }
    }

    .starfield{
      position:absolute; inset:-40px;
      background-image:
        radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.20), transparent 60%),
        radial-gradient(1px 1px at 30% 70%, rgba(255,255,255,.16), transparent 60%),
        radial-gradient(1px 1px at 75% 35%, rgba(255,255,255,.18), transparent 60%),
        radial-gradient(1px 1px at 60% 85%, rgba(255,255,255,.14), transparent 60%),
        radial-gradient(1px 1px at 90% 65%, rgba(255,255,255,.15), transparent 60%),
        radial-gradient(1px 1px at 45% 10%, rgba(255,255,255,.14), transparent 60%),
        radial-gradient(1px 1px at 15% 90%, rgba(255,255,255,.12), transparent 60%);
      opacity:.65;
      animation: twinkle 6s ease-in-out infinite;
    }
    @keyframes twinkle{
      0%,100%{ opacity:.55; }
      50%{ opacity:.85; }
    }

    .sheen{
      position:absolute; inset:-120px;
      background: conic-gradient(from 180deg at 50% 50%, transparent 0 40%, rgba(255,255,255,.07) 48%, transparent 56% 100%);
      transform: rotate(0deg);
      animation: spinSheen 18s linear infinite;
      opacity:.35;
    }
    @keyframes spinSheen{
      to{ transform: rotate(360deg); }
    }

    /* ====== layout ====== */
    .app{max-width:980px;margin:0 auto;display:flex;flex-direction:column;gap:12px;}

    /* ===== header like photos ===== */
    .topbar{
      position:relative;
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.07);
      border-radius:18px;
      padding:12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      overflow:hidden;
    }
    .topbar:before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(135deg, rgba(51,166,255,.12), transparent 35%, rgba(124,77,255,.10));
      opacity:.65;
      pointer-events:none;
    }
    .topbar:after{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(600px 120px at 20% 0%, rgba(255,255,255,.12), transparent 60%);
      pointer-events:none;
      opacity:.35;
    }

    .topLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      position:relative;
      z-index:1;
    }
    .avatar{
      width:42px;height:42px;
      border-radius:50%;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      overflow:hidden;
      flex:0 0 auto;
      display:grid;
      place-items:center;
      color:var(--muted);
      font-weight:900;
      user-select:none;
      box-shadow: 0 14px 28px rgba(0,0,0,.22);
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:block;}

    .title{display:flex;flex-direction:column;gap:3px;line-height:1.1;min-width:0; position:relative; z-index:1;}
    .title b{font-size:17px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; letter-spacing:.2px;}
    .title small{color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end; position:relative; z-index:1;}
    .balanceWrap{gap:8px;}
    .pill{
      padding:8px 10px;
      border-radius:999px;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.08);
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      font-weight:900;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
    }
    .starImg{
      width:18px;height:18px;object-fit:contain;display:block;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,.35));
    }
    .plusBtn{
      width:44px;height:44px;
      border-radius:999px;
      border:1px solid rgba(51,166,255,0.35);
      background:rgba(51,166,255,0.95);
      color:#06121b;
      font-weight:1000;
      font-size:22px;
      cursor:pointer;
      display:grid;place-items:center;
      box-shadow:0 14px 30px rgba(0,0,0,.28);
      user-select:none;
      touch-action:manipulation;
      position:relative;
      overflow:hidden;
    }
    .plusBtn:before{
      content:"";
      position:absolute; inset:-40px;
      background: radial-gradient(60px 60px at 25% 20%, rgba(255,255,255,.6), transparent 60%);
      opacity:.35;
      pointer-events:none;
    }
    .plusBtn:disabled{opacity:.45;cursor:not-allowed;}

    .btn{
      border:0;
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      background:var(--accent);
      color:#06121b;
      cursor:pointer;
      user-select:none;
      touch-action:manipulation;
      box-shadow:0 12px 24px rgba(0,0,0,.24);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed;}
    .btn.secondary{
      background:rgba(255,255,255,0.08);
      color:var(--text);
      border:1px solid rgba(255,255,255,0.12);
      box-shadow:none;
    }
    .btn.danger{
      background:rgba(255,77,77,0.18);
      color:var(--text);
      border:1px solid rgba(255,77,77,0.35);
      box-shadow:none;
    }

    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:999px;
      padding:6px;
      width:fit-content;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .tab{
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      color:var(--muted);
      user-select:none;
    }
    .tab.active{
      background:rgba(51,166,255,0.18);
      border:1px solid rgba(51,166,255,0.35);
      color:var(--text);
    }

    .card{
      position:relative;
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:18px;
      padding:12px;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(420px 90px at 20% 0%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(520px 120px at 90% 10%, rgba(51,166,255,.10), transparent 62%);
      opacity:.55;
      pointer-events:none;
    }
    .card h3{
      margin:0 0 10px 0;
      font-size:14px;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.2px;
      text-transform:uppercase;
      position:relative;
      z-index:1;
    }

    /* –ö–µ–π—Å—ã */
    .casesRow{
      position:relative; z-index:1;
      display:flex;
      gap:10px;
      overflow:auto;
      padding-bottom:6px;
      -webkit-overflow-scrolling:touch;
      scroll-snap-type:x mandatory;
    }
    .caseCard{
      flex:0 0 240px;
      scroll-snap-align:start;
      border-radius:18px;
      background:rgba(0,0,0,0.16);
      border:1px solid rgba(255,255,255,0.10);
      padding:12px;
      display:flex;
      gap:12px;
      align-items:center;
      cursor:pointer;
      user-select:none;
      position:relative;
      overflow:hidden;
    }
    .caseCard:before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(120deg, rgba(255,255,255,.08), transparent 45%, rgba(51,166,255,.10));
      opacity:.35;
      pointer-events:none;
    }
    .caseCard.active{
      border-color:rgba(51,166,255,0.7);
      box-shadow:0 0 0 4px rgba(51,166,255,0.10);
    }
    .caseArt{
      width:64px;height:64px;
      border-radius:16px;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      display:grid;place-items:center;
      flex:0 0 auto;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
    }
    .caseArt svg{width:44px;height:44px;display:block;filter: drop-shadow(0 8px 12px rgba(0,0,0,.28));}
    .caseInfo{min-width:0;display:flex;flex-direction:column;gap:6px; position:relative; z-index:1;}
    .caseName{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .priceLine{display:flex;align-items:center;gap:6px;font-weight:900;}
    .priceLine small{color:var(--muted);font-weight:700}

    /* –†—É–ª–µ—Ç–∫–∞ */
    .rouletteWrap{display:flex;flex-direction:column;gap:10px;}
    .window{
      position:relative;
      height: var(--itemH);
      overflow:hidden;
      border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.08);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .fadeLeft, .fadeRight{
      position:absolute;top:0;bottom:0;width:44px;z-index:3;pointer-events:none;
    }
    .fadeLeft{left:0;background:linear-gradient(90deg, rgba(15,23,32,1), rgba(15,23,32,0));}
    .fadeRight{right:0;background:linear-gradient(270deg, rgba(15,23,32,1), rgba(15,23,32,0));}
    .centerLine{
      position:absolute;top:0;bottom:0;left:50%;
      width:2px;background:rgba(51,166,255,.35);z-index:2;
    }
    .pointer{
      position:absolute;
      left:50%;
      top:6px;
      transform:translateX(-50%);
      width:0;height:0;
      border-left:12px solid transparent;
      border-right:12px solid transparent;
      border-top:16px solid rgba(51,166,255,.95);
      z-index:4;
      filter:drop-shadow(0 8px 12px rgba(0,0,0,.35));
    }
    .track{
      position:absolute;
      top:0;left:0;height:100%;
      display:flex;
      will-change:transform;
      transform:translateX(0px);
      z-index:1;
    }
    .item{
      width:var(--itemW);
      height:var(--itemH);
      padding:10px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:8px;
      border-right:1px solid rgba(255,255,255,0.06);
      background:rgba(0,0,0,0.03);
      position:relative;
    }
    .item:nth-child(2n){ background:rgba(255,255,255,0.02); }
    .itemEmoji{
      width:54px;height:54px;
      border-radius:18px;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      display:grid;place-items:center;
      flex:0 0 auto;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .itemEmoji svg{
      width:38px;height:38px;display:block;
      filter: drop-shadow(0 10px 12px rgba(0,0,0,.30));
    }
    .itemName{
      font-weight:900;
      font-size:13px;
      text-align:center;
      line-height:1.15;
      padding:0 4px;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-height:30px;
      position:relative;
      z-index:1;
    }
    .itemCost{
      display:flex;align-items:center;gap:6px;
      font-weight:900;
      position:relative;
      z-index:1;
    }
    .badge{
      font-size:12px;
      color:var(--muted);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.04);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .controls{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      position:relative; z-index:1;
    }
    .hint{color:var(--muted);font-size:12px;line-height:1.3;}
    .result{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(0,0,0,0.18);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      position:relative;
      z-index:1;
    }
    .result b{font-size:14px}

    /* –ü—Ä–æ—Ñ–∏–ª—å */
    .profileHeader{
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      position:relative; z-index:1;
    }
    .userBox{display:flex;flex-direction:column;gap:2px;}
    .userBox b{font-size:15px}
    .invList{display:flex;flex-direction:column;gap:8px;margin-top:10px; position:relative; z-index:1;}
    .invItem{
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(0,0,0,0.16);
      padding:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      overflow:hidden;
      position:relative;
    }
    .invItem:before{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(420px 120px at 10% 0%, rgba(255,255,255,.08), transparent 60%);
      opacity:.35;
      pointer-events:none;
    }
    .invLeft{display:flex;gap:10px;align-items:center;min-width:0; position:relative; z-index:1;}
    .miniEmoji{
      width:38px;height:38px;border-radius:14px;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      display:grid;place-items:center;
      flex:0 0 auto;
    }
    .miniEmoji svg{width:24px;height:24px;display:block;filter: drop-shadow(0 8px 10px rgba(0,0,0,.28));}
    .invName{
      font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      max-width:55vw;
    }
    .invMeta{color:var(--muted);font-size:12px;margin-top:2px;}
    .invRight{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end; position:relative; z-index:1;}
    .smallPrice{
      display:flex;align-items:center;gap:6px;font-weight:900;
      white-space:nowrap;
    }
    .empty{
      padding:14px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,0.15);
      color:var(--muted);
      text-align:center;
      margin-top:10px;
      position:relative; z-index:1;
    }

    /* –ú–æ–¥–∞–ª–∫–∞ keep/sell */
    .modalBack{
      position:fixed;inset:0;
      background:rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .modal{
      width:min(520px, 100%);
      border-radius:18px;
      background:rgba(15,23,32,0.96);
      border:1px solid rgba(255,255,255,0.10);
      box-shadow:0 20px 60px rgba(0,0,0,0.45);
      padding:14px;
      overflow:hidden;
      position:relative;
    }
    .modal:before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(135deg, rgba(51,166,255,.14), transparent 45%, rgba(124,77,255,.12));
      opacity:.55;
      pointer-events:none;
    }
    .modalTop{display:flex;justify-content:space-between;align-items:center;gap:10px; position:relative; z-index:1;}
    .modalTop b{font-size:16px}
    .closeX{cursor:pointer;color:var(--muted);font-weight:900;padding:6px 10px;border-radius:12px;}
    .closeX:hover{background:rgba(255,255,255,0.06);color:var(--text);}
    .modalBody{margin-top:10px;display:flex;gap:12px;align-items:center; position:relative; z-index:1;}
    .bigEmoji{
      width:74px;height:74px;border-radius:22px;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      display:grid;place-items:center;flex:0 0 auto;
    }
    .bigEmoji svg{width:48px;height:48px;display:block;filter: drop-shadow(0 12px 14px rgba(0,0,0,.32));}
    .modalActions{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end; position:relative; z-index:1;}

    /* bottom nav like photos */
    .bottomNav{
      position:fixed;
      left:0; right:0; bottom:0;
      height:74px;
      background:rgba(10,16,22,0.92);
      border-top:1px solid rgba(255,255,255,0.06);
      display:flex;
      justify-content:space-around;
      align-items:center;
      padding:8px 10px 10px;
      z-index:999;
      backdrop-filter: blur(10px);
    }
    .navItem{
      border:0;
      background:transparent;
      color:rgba(231,238,247,0.55);
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:center;
      font-weight:900;
      font-size:11px;
      cursor:pointer;
      user-select:none;
    }
    .navItem:disabled{opacity:.35;cursor:not-allowed;}
    .navItem .navIco{font-size:18px;line-height:1;}
    .navItem.active{color:rgba(51,166,255,0.95);}

    /* mobile polish */
    @media (max-width:420px){
      :root{ --itemW: 135px; --itemH: 118px; }
      .caseCard{ flex-basis: 220px; }
    }
  </style>
</head>

<body>
  <!-- –º–Ω–æ–≥–æ –¥–µ–∫–æ—Ä–∞ -->
  <div class="bgDecor">
    <div class="blob b1"></div>
    <div class="blob b2"></div>
    <div class="blob b3"></div>
    <div class="starfield"></div>
    <div class="sheen"></div>
  </div>

  <div class="app">
    <div class="topbar">
      <div class="topLeft">
        <div class="avatar" id="avatar"><span id="avatarFallback">EG</span></div>
        <div class="title">
          <!-- ‚úÖ —Ç—É—Ç –±—É–¥–µ—Ç –Ω–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
          <b id="headerTitle">‚Äî</b>
          <!-- ‚úÖ ‚Äú‚≠ê –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ‚Äù -->
          <small id="subTitle">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</small>
        </div>
      </div>

      <div class="row balanceWrap">
        <div class="pill" title="–ë–∞–ª–∞–Ω—Å –∑–≤—ë–∑–¥">
          <img class="starImg" src="img/Star.png" alt="‚≠ê" onerror="this.style.display='none'">
          <span id="stars">0</span>
        </div>
        <!-- + –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—É -->
        <button class="plusBtn" id="addStarsBtn" title="–ü–æ–ø–æ–ª–Ω–∏—Ç—å">+</button>
      </div>
    </div>

    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="main">–ì–ª–∞–≤–Ω–∞—è</div>
      <div class="tab" data-tab="profile">–ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>

    <!-- MAIN -->
    <div id="tab_main" class="tabPage">
      <div class="card">
        <h3>–ö–µ–π—Å—ã</h3>
        <div class="casesRow" id="casesRow"></div>
      </div>

      <div class="card rouletteWrap">
        <h3>–†—É–ª–µ—Ç–∫–∞</h3>

        <div class="window" id="window">
          <div class="fadeLeft"></div>
          <div class="fadeRight"></div>
          <div class="centerLine"></div>
          <div class="pointer"></div>
          <div class="track" id="track"></div>
        </div>

        <div class="controls">
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
            <span class="badge" id="caseBadge">–ö–µ–π—Å: ‚Äî</span>
            <span class="badge" id="cooldownBadge">–î–æ—Å—Ç—É–ø–Ω–æ</span>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn secondary" id="demoBtn" title="–î–µ–º–æ –Ω–µ —Ç—Ä–∞—Ç–∏—Ç –∑–≤—ë–∑–¥—ã, –Ω–µ —Å—Ç–∞–≤–∏—Ç –∫–¥">–î–µ–º–æ</button>
            <button class="btn" id="spinBtn">–ò—Å–ø—ã—Ç–∞–π —É–¥–∞—á—É</button>
          </div>
        </div>

        <div class="result">
          <div>
            <div class="hint">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
            <b id="resultText">–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ</b>
          </div>
          <div class="hint" id="resultMeta"></div>
        </div>
      </div>
    </div>

    <!-- PROFILE -->
    <div id="tab_profile" class="tabPage" style="display:none;">
      <div class="card">
        <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>

        <div class="profileHeader">
          <div class="userBox">
            <b id="userName">‚Äî</b>
            <!-- ‚úÖ ID —É–±—Ä–∞–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é -->
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
            <button class="btn secondary" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
            <button class="btn danger" id="wipeBtn">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
          </div>
        </div>

        <div class="hint" style="margin-top:8px;">
          –ó–¥–µ—Å—å —Ö—Ä–∞–Ω—è—Ç—Å—è ‚Äú–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ‚Äù –ø–æ–¥–∞—Ä–∫–∏. –ú–æ–∂–Ω–æ –ø—Ä–æ–¥–∞—Ç—å –∏—Ö –∑–∞ ‚≠ê.
        </div>

        <div id="invWrap"></div>

        <div id="adminBlock" style="display:none;margin-top:12px; position:relative; z-index:1;">
          <div class="hint" style="margin-bottom:8px;">–ê–¥–º–∏–Ω: @RealZanT</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
            <button class="btn secondary" id="adminAdd100">+100 ‚≠ê</button>
            <button class="btn secondary" id="adminResetCd">–°–±—Ä–æ—Å–∏—Ç—å –ö–î</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL keep/sell -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalTop">
        <b>–í—ã–ø–∞–ª –ø–æ–¥–∞—Ä–æ–∫</b>
        <div class="closeX" id="modalClose">‚úï</div>
      </div>

      <div class="modalBody">
        <div class="bigEmoji" id="modalEmoji"></div>
        <div style="min-width:0;">
          <div style="font-weight:900;font-size:14px;" id="modalName">‚Äî</div>
          <div class="hint" id="modalInfo">‚Äî</div>
          <div style="margin-top:8px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <div class="smallPrice">
              <img class="starImg" src="img/Star.png" alt="‚≠ê" onerror="this.style.display='none'">
              <span id="modalCost">0</span>
              <span class="hint">—Å—Ç–æ–∏–º–æ—Å—Ç—å</span>
            </div>
            <div class="smallPrice">
              <img class="starImg" src="img/Star.png" alt="‚≠ê" onerror="this.style.display='none'">
              <span id="modalSell">0</span>
              <span class="hint">–∑–∞ –ø—Ä–æ–¥–∞–∂—É</span>
            </div>
          </div>
        </div>
      </div>

      <div class="modalActions">
        <button class="btn secondary" id="keepBtn">–û—Å—Ç–∞–≤–∏—Ç—å</button>
        <button class="btn" id="sellBtn">–ü—Ä–æ–¥–∞—Ç—å –∑–∞ ‚≠ê</button>
      </div>
    </div>
  </div>

  <!-- bottom nav -->
  <nav class="bottomNav">
    <button class="navItem active" data-go="main">
      <span class="navIco">üéÅ</span><span>–ì–ª–∞–≤–Ω–∞—è</span>
    </button>
    <button class="navItem" title="–°–∫–æ—Ä–æ" disabled>
      <span class="navIco">üé≤</span><span>–õ–æ—Ç–µ—Ä–µ—è</span>
    </button>
    <button class="navItem" title="–°–∫–æ—Ä–æ" disabled>
      <span class="navIco">‚è≥</span><span>–°–∫–æ—Ä–æ</span>
    </button>
    <button class="navItem" title="–°–∫–æ—Ä–æ" disabled>
      <span class="navIco">‚¨ÜÔ∏è</span><span>–ê–ø–≥—Ä–µ–π–¥</span>
    </button>
    <button class="navItem" data-go="profile">
      <span class="navIco">üë§</span><span>–ü—Ä–æ—Ñ–∏–ª—å</span>
    </button>
  </nav>

<script>
/* ==========================
   SETTINGS
========================== */
const COOLDOWN_MS = 24 * 60 * 60 * 1000; // 24—á
const SELL_RATE = 0.20;                   // 20%
const ADMIN_USERNAME = "@RealZanT";

/* ==========================
   SVG ICONS (–≤–º–µ—Å—Ç–æ emoji)
========================== */
function svgWrap(inner, viewBox="0 0 64 64"){
  return `<svg viewBox="${viewBox}" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">${inner}</svg>`;
}
const ICONS = {
  caseGift: svgWrap(`
    <defs>
      <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#33a6ff"/><stop offset="1" stop-color="#7c4dff"/>
      </linearGradient>
    </defs>
    <rect x="10" y="26" width="44" height="26" rx="8" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.20)"/>
    <rect x="10" y="20" width="44" height="12" rx="6" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.18)"/>
    <path d="M32 20v32" stroke="url(#g1)" stroke-width="6" stroke-linecap="round"/>
    <path d="M10 32h44" stroke="url(#g1)" stroke-width="6" stroke-linecap="round"/>
    <path d="M32 20c-7 0-10-4-10-7 0-3 3-5 6-4 3 1 4 4 4 7z" fill="url(#g1)"/>
    <path d="M32 20c7 0 10-4 10-7 0-3-3-5-6-4-3 1-4 4-4 7z" fill="url(#g1)"/>
  `),
  caseBear: svgWrap(`
    <defs><linearGradient id="b1" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#33a6ff"/><stop offset="1" stop-color="#1ee1a6"/>
    </linearGradient></defs>
    <circle cx="20" cy="18" r="8" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.20)"/>
    <circle cx="44" cy="18" r="8" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.20)"/>
    <circle cx="32" cy="34" r="20" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.18)"/>
    <circle cx="25" cy="30" r="3" fill="#e7eef7"/><circle cx="39" cy="30" r="3" fill="#e7eef7"/>
    <path d="M28 40c2 2 6 2 8 0" stroke="url(#b1)" stroke-width="4" stroke-linecap="round"/>
    <path d="M30 35c0 4 4 4 4 0" stroke="rgba(255,255,255,.5)" stroke-width="4" stroke-linecap="round"/>
  `),
  caseHeart: svgWrap(`
    <defs><linearGradient id="h1" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#ff4d9d"/><stop offset="1" stop-color="#7c4dff"/>
    </linearGradient></defs>
    <path d="M32 52s-18-10-22-22c-3-9 3-18 12-18 5 0 8 2 10 5 2-3 5-5 10-5 9 0 15 9 12 18-4 12-22 22-22 22z"
      fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.18)" stroke-width="2"/>
    <path d="M32 50s-16-9-19-19c-2-7 2-14 10-14 4 0 7 2 9 5 2-3 5-5 9-5 8 0 12 7 10 14-3 10-19 19-19 19z"
      fill="url(#h1)" opacity=".9"/>
  `),

  star2: svgWrap(`
    <defs><linearGradient id="s1" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#ffd86b"/><stop offset="1" stop-color="#ff9f1c"/>
    </linearGradient></defs>
    <path d="M32 6l7 16 17 2-12 11 4 17-16-9-16 9 4-17-12-11 17-2 7-16z" fill="url(#s1)" stroke="rgba(255,255,255,.25)" stroke-width="2"/>
    <text x="32" y="38" text-anchor="middle" font-size="18" font-weight="900" fill="rgba(8,12,18,.8)">2</text>
  `),

  heart: svgWrap(`
    <defs><linearGradient id="hg" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#ff4d9d"/><stop offset="1" stop-color="#ff4d4d"/>
    </linearGradient></defs>
    <path d="M32 54s-18-10-22-22c-3-9 3-18 12-18 5 0 8 2 10 5 2-3 5-5 10-5 9 0 15 9 12 18-4 12-22 22-22 22z"
      fill="url(#hg)" opacity=".95" stroke="rgba(255,255,255,.22)" stroke-width="2"/>
  `),

  lolli: svgWrap(`
    <defs><linearGradient id="lg" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#7c4dff"/><stop offset="1" stop-color="#33a6ff"/>
    </linearGradient></defs>
    <circle cx="28" cy="28" r="16" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.18)" stroke-width="2"/>
    <path d="M18 22c6-8 18-8 24 0" stroke="url(#lg)" stroke-width="4" stroke-linecap="round"/>
    <path d="M18 34c6 8 18 8 24 0" stroke="url(#lg)" stroke-width="4" stroke-linecap="round"/>
    <path d="M40 40l14 14" stroke="rgba(255,255,255,.35)" stroke-width="4" stroke-linecap="round"/>
  `),

  flower: svgWrap(`
    <defs><linearGradient id="fg" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#1ee1a6"/><stop offset="1" stop-color="#33a6ff"/>
    </linearGradient></defs>
    <circle cx="32" cy="32" r="6" fill="rgba(255,255,255,.85)"/>
    <g fill="url(#fg)" opacity=".95" stroke="rgba(255,255,255,.18)" stroke-width="2">
      <ellipse cx="32" cy="16" rx="10" ry="12"/>
      <ellipse cx="32" cy="48" rx="10" ry="12"/>
      <ellipse cx="16" cy="32" rx="12" ry="10"/>
      <ellipse cx="48" cy="32" rx="12" ry="10"/>
      <ellipse cx="21" cy="21" rx="10" ry="12" transform="rotate(-45 21 21)"/>
      <ellipse cx="43" cy="21" rx="10" ry="12" transform="rotate(45 43 21)"/>
      <ellipse cx="21" cy="43" rx="10" ry="12" transform="rotate(45 21 43)"/>
      <ellipse cx="43" cy="43" rx="10" ry="12" transform="rotate(-45 43 43)"/>
    </g>
  `),

  cake: svgWrap(`
    <defs><linearGradient id="cg" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#ff9f1c"/><stop offset="1" stop-color="#ff4d9d"/>
    </linearGradient></defs>
    <rect x="14" y="30" width="36" height="22" rx="8" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.18)" stroke-width="2"/>
    <path d="M14 34c6 6 12-6 18 0s12-6 18 0v6H14z" fill="url(#cg)" opacity=".9"/>
    <path d="M22 24h20" stroke="rgba(255,255,255,.35)" stroke-width="6" stroke-linecap="round"/>
    <path d="M32 12v10" stroke="rgba(255,255,255,.35)" stroke-width="4" stroke-linecap="round"/>
    <circle cx="32" cy="12" r="3" fill="url(#cg)"/>
  `),

  potion: svgWrap(`
    <defs><linearGradient id="pg" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#33a6ff"/><stop offset="1" stop-color="#1ee1a6"/>
    </linearGradient></defs>
    <path d="M26 10h12" stroke="rgba(255,255,255,.35)" stroke-width="6" stroke-linecap="round"/>
    <path d="M28 10v10l-8 12c-3 5 1 12 8 12h8c7 0 11-7 8-12l-8-12V10"
      fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.18)" stroke-width="2"/>
    <path d="M22 40c2 4 6 6 10 6s8-2 10-6c-6-4-24-4-20 0z" fill="url(#pg)" opacity=".9"/>
  `),

  shoe: svgWrap(`
    <defs><linearGradient id="sg2" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#7c4dff"/><stop offset="1" stop-color="#ff4d9d"/>
    </linearGradient></defs>
    <path d="M14 40c8 0 12-8 14-14 6 4 10 10 22 10 4 0 6 2 6 6v6H14z"
      fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.18)" stroke-width="2"/>
    <path d="M28 26c3 5 8 10 22 10" stroke="url(#sg2)" stroke-width="4" stroke-linecap="round"/>
  `),

  rose: svgWrap(`
    <defs><linearGradient id="rg" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#ff4d4d"/><stop offset="1" stop-color="#ff4d9d"/>
    </linearGradient></defs>
    <path d="M32 12c8 0 10 8 6 12 4 1 6 8 0 12-3 2-8 2-12 0-6-4-4-11 0-12-4-4-2-12 6-12z"
      fill="url(#rg)" opacity=".95" stroke="rgba(255,255,255,.20)" stroke-width="2"/>
    <path d="M32 36v18" stroke="rgba(30,225,166,.8)" stroke-width="4" stroke-linecap="round"/>
    <path d="M32 44c-6 0-10-4-12-7" stroke="rgba(30,225,166,.6)" stroke-width="4" stroke-linecap="round"/>
  `),

  ring: svgWrap(`
    <defs><linearGradient id="ringg" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#33a6ff"/><stop offset="1" stop-color="#ffd86b"/>
    </linearGradient></defs>
    <circle cx="32" cy="36" r="14" fill="rgba(255,255,255,.06)" stroke="url(#ringg)" stroke-width="5"/>
    <path d="M28 18l4-8 4 8z" fill="url(#ringg)" opacity=".95"/>
    <circle cx="32" cy="18" r="4" fill="rgba(255,255,255,.7)"/>
  `),

  bear: svgWrap(`
    <defs><linearGradient id="bg2" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#33a6ff"/><stop offset="1" stop-color="#1ee1a6"/>
    </linearGradient></defs>
    <circle cx="20" cy="18" r="8" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.20)"/>
    <circle cx="44" cy="18" r="8" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.20)"/>
    <circle cx="32" cy="34" r="20" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.18)"/>
    <circle cx="25" cy="30" r="3" fill="#e7eef7"/><circle cx="39" cy="30" r="3" fill="#e7eef7"/>
    <path d="M28 40c2 2 6 2 8 0" stroke="url(#bg2)" stroke-width="4" stroke-linecap="round"/>
    <path d="M30 35c0 4 4 4 4 0" stroke="rgba(255,255,255,.5)" stroke-width="4" stroke-linecap="round"/>
  `),
};

/* ==========================
   HELPERS / USER
========================== */
function safeJsonParse(s, fallback){ try { return JSON.parse(s); } catch { return fallback; } }
function nowMs(){ return Date.now(); }
function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }
function fmtTimeLeft(ms){
  ms = Math.max(0, ms);
  const totalSec = Math.floor(ms/1000);
  const h = Math.floor(totalSec/3600);
  const m = Math.floor((totalSec%3600)/60);
  const s = totalSec%60;
  const pad = (x)=>String(x).padStart(2,"0");
  return `${pad(h)}:${pad(m)}:${pad(s)}`;
}
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function getTelegramUser(){
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  if (!tg) return null;
  const u = tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;
  if (!u || !u.id) return null;
  try { tg.expand(); } catch {}
  return {
    id: String(u.id),
    username: u.username ? "@"+u.username : "",
    first_name: u.first_name || "",
    last_name: u.last_name || "",
    photo_url: u.photo_url || ""
  };
}
function ensureGuestUser(){
  const key = "eg_guest_id";
  let id = localStorage.getItem(key);
  if (!id){
    id = "guest_" + Math.random().toString(16).slice(2) + "_" + Date.now();
    localStorage.setItem(key, id);
  }
  return { id, username:"", first_name:"–ì–æ—Å—Ç—å", last_name:"", photo_url:"" };
}

let USER = null;
let IS_ADMIN = false;

function kBalance(){ return `eg_balance_${USER.id}`; }
function kInv(){ return `eg_inventory_${USER.id}`; }
function kLastSpin(){ return `eg_lastSpin_${USER.id}`; }
function kEarned(){ return `eg_earned_${USER.id}`; }

function getDisplayName(){
  const name = [USER.first_name, USER.last_name].filter(Boolean).join(" ").trim() || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
  return USER.username || name;
}

/* ==========================
   DATA (SVG –≤–º–µ—Å—Ç–æ emoji)
   ‚úÖ –í –¥–µ—à—ë–≤–æ–º –∫–µ–π—Å–µ –≤–º–µ—Å—Ç–æ 1‚≠ê -> 2‚≠ê
========================== */
const CASES = [
  {
    id: "case_1",
    iconKey: "caseGift",
    name: "–ö–µ–π—Å –∑–∞ 1‚≠ê",
    price: 1,
    gifts: [
      {id:"g_star2", iconKey:"star2", name:"2 –∑–≤–µ–∑–¥—ã", cost:2, weight:70, isStars:true},
      {id:"g_heart", iconKey:"heart", name:"–°–µ—Ä–¥—Ü–µ",  cost:15,  weight:30},
      {id:"g_lolli", iconKey:"lolli", name:"–õ–µ–¥–µ–Ω–µ—Ü", cost:560, weight:16},
      {id:"g_flwr",  iconKey:"flower",name:"–¶–≤–µ—Ç–æ–∫",  cost:1280,weight:10},
      {id:"g_cake",  iconKey:"cake",  name:"–¢–æ—Ä—Ç",    cost:780, weight:12},
      {id:"g_potion",iconKey:"potion",name:"–ó–µ–ª—å–µ",   cost:2300,weight:4},
    ]
  },
  {
    id: "case_5",
    iconKey: "caseBear",
    name: "–ö–µ–π—Å –∑–∞ 5‚≠ê",
    price: 5,
    gifts: [
      {id:"g_cake2",  iconKey:"cake",  name:"–¢–æ—Ä—Ç —Å –≤–∏—à–Ω–µ–π", cost:780,  weight:18},
      {id:"g_flwr2",  iconKey:"flower",name:"–¶–≤–µ—Ç–æ–∫",       cost:1280, weight:16},
      {id:"g_shoe",   iconKey:"shoe",  name:"–¢—É—Ñ–ª–∏",        cost:1750, weight:12},
      {id:"g_potion2",iconKey:"potion",name:"–ó–µ–ª—å–µ",        cost:2300, weight:10},
      {id:"g_rose",   iconKey:"rose",  name:"–†–æ–∑–∞ –≤ –∫–æ–ª–±–µ", cost:3500, weight:6},
      {id:"g_ring",   iconKey:"ring",  name:"–ö–æ–ª—å—Ü–æ",       cost:3900, weight:4},
    ]
  },
  {
    id: "case_40",
    iconKey: "caseHeart",
    name: "–ö–µ–π—Å –∑–∞ 40‚≠ê",
    price: 40,
    gifts: [
      {id:"g_bear",  iconKey:"bear",  name:"–ú–∏—à–∫–∞",        cost:5500, weight:6},
      {id:"g_ring2", iconKey:"ring",  name:"–ö–æ–ª—å—Ü–æ",       cost:3900, weight:10},
      {id:"g_rose2", iconKey:"rose",  name:"–†–æ–∑–∞ –≤ –∫–æ–ª–±–µ", cost:3500, weight:10},
      {id:"g_shoe2", iconKey:"shoe",  name:"–¢—É—Ñ–ª–∏",        cost:1750, weight:18},
      {id:"g_flwr3", iconKey:"flower",name:"–¶–≤–µ—Ç–æ–∫",       cost:1280, weight:22},
      {id:"g_lolli2",iconKey:"lolli", name:"–õ–µ–¥–µ–Ω–µ—Ü",      cost:560,  weight:26},
    ]
  }
];

/* ==========================
   STATE
========================== */
const els = {
  headerTitle: document.getElementById("headerTitle"),
  subTitle: document.getElementById("subTitle"),
  avatar: document.getElementById("avatar"),
  avatarFallback: document.getElementById("avatarFallback"),

  stars: document.getElementById("stars"),
  addStarsBtn: document.getElementById("addStarsBtn"),

  casesRow: document.getElementById("casesRow"),
  caseBadge: document.getElementById("caseBadge"),
  cooldownBadge: document.getElementById("cooldownBadge"),
  track: document.getElementById("track"),
  window: document.getElementById("window"),
  spinBtn: document.getElementById("spinBtn"),
  demoBtn: document.getElementById("demoBtn"),
  resultText: document.getElementById("resultText"),
  resultMeta: document.getElementById("resultMeta"),

  userName: document.getElementById("userName"),
  invWrap: document.getElementById("invWrap"),
  exportBtn: document.getElementById("exportBtn"),
  wipeBtn: document.getElementById("wipeBtn"),

  modalBack: document.getElementById("modalBack"),
  modalClose: document.getElementById("modalClose"),
  modalEmoji: document.getElementById("modalEmoji"),
  modalName: document.getElementById("modalName"),
  modalInfo: document.getElementById("modalInfo"),
  modalCost: document.getElementById("modalCost"),
  modalSell: document.getElementById("modalSell"),
  keepBtn: document.getElementById("keepBtn"),
  sellBtn: document.getElementById("sellBtn"),

  adminBlock: document.getElementById("adminBlock"),
  adminAdd100: document.getElementById("adminAdd100"),
  adminResetCd: document.getElementById("adminResetCd"),
};

let stars = 0;
let earned = 0;
let inventory = [];
let activeCase = CASES[0];
let isSpinning = false;
let pendingGift = null;

/* ==========================
   ICON RENDER
========================== */
function renderIcon(key, fallbackText="üéÅ"){
  const svg = ICONS[key];
  if (svg) return svg;
  return `<span style="font-size:28px">${escapeHtml(fallbackText)}</span>`;
}

/* ==========================
   INIT USER
========================== */
function initUser(){
  const tgUser = getTelegramUser();
  USER = tgUser ? tgUser : ensureGuestUser();
  IS_ADMIN = (USER.username === ADMIN_USERNAME);

  const name = [USER.first_name, USER.last_name].filter(Boolean).join(" ").trim() || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
  const nick = USER.username ? USER.username : "";
  const displayName = nick || name;

  // avatar
  if (USER.photo_url){
    els.avatarFallback.style.display = "none";
    els.avatar.innerHTML = `<img src="${escapeHtml(USER.photo_url)}" alt="avatar">`;
  } else {
    els.avatarFallback.textContent = (displayName.replace("@","").slice(0,2) || "EG").toUpperCase();
  }

  // ‚úÖ –í–ú–ï–°–¢–û "Easy Gift ‚Äî Mini App" -> –¢–û–õ–¨–ö–û –ù–ò–ö / –ò–ú–Ø
  els.headerTitle.textContent = displayName;

  els.userName.textContent = `${name} ${nick}`.trim();

  // admin UI
  els.adminBlock.style.display = IS_ADMIN ? "" : "none";
  els.addStarsBtn.disabled = !IS_ADMIN;

  // tg colors
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  if (tg){
    try { tg.setHeaderColor("#0f1720"); } catch {}
    try { tg.setBackgroundColor("#0f1720"); } catch {}
  }
}

/* ==========================
   STORAGE
========================== */
function saveBalance(){ localStorage.setItem(kBalance(), String(stars)); }
function saveEarned(){ localStorage.setItem(kEarned(), String(earned)); }
function saveInventory(){ localStorage.setItem(kInv(), JSON.stringify(inventory)); }

function updateStarsUI(){ els.stars.textContent = String(stars); }
function updateHeaderEarned(){
  els.subTitle.textContent = `${getDisplayName()} ‚Ä¢ ${earned} ‚≠ê –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ`;
}
function addEarned(n){
  const x = Number(n)||0;
  if (x <= 0) return;
  earned += x;
  saveEarned();
  updateHeaderEarned();
}

function loadAll(){
  const savedBal = Number(localStorage.getItem(kBalance()));

  // ‚úÖ –≤—Å–µ–º –º–∏–Ω–∏–º—É–º 1‚≠ê (—á—Ç–æ–±—ã "–∑–∞—à—ë–ª –∑–≤–µ–∑–¥—É –Ω–µ –¥–∞–ª–∏" –Ω–µ –±—ã–ª–æ)
  if (Number.isFinite(savedBal)) {
    stars = IS_ADMIN ? savedBal : Math.max(1, savedBal);
  } else {
    stars = 1;
    localStorage.setItem(kBalance(), "1");
  }

  const savedEarned = Number(localStorage.getItem(kEarned()));
  earned = Number.isFinite(savedEarned) ? savedEarned : 0;

  inventory = safeJsonParse(localStorage.getItem(kInv()), []);
  if (!Array.isArray(inventory)) inventory = [];

  updateStarsUI();
  updateHeaderEarned();
}

/* ==========================
   TABS + bottom nav
========================== */
function setTab(name){
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.tab === name);
  });
  document.querySelectorAll(".tabPage").forEach(p=>p.style.display="none");
  document.getElementById("tab_"+name).style.display = "";
  if (name === "profile") renderInventory();
}
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=> setTab(t.dataset.tab));
});
document.querySelectorAll(".bottomNav .navItem[data-go]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const go = btn.getAttribute("data-go");
    document.querySelectorAll(".bottomNav .navItem").forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");
    setTab(go);
  });
});

/* ==========================
   ROULETTE
========================== */
function weightedPick(list){
  const total = list.reduce((s,g)=>s + (g.weight || 1), 0);
  let r = Math.random() * total;
  for (let i=0;i<list.length;i++){
    r -= (list[i].weight || 1);
    if (r <= 0) return { gift:list[i], index:i };
  }
  return { gift:list[list.length-1], index:list.length-1 };
}

function buildTrack(baseGifts){
  const repeats = 18;
  const items = [];
  for (let r=0;r<repeats;r++){
    for (const g of baseGifts) items.push(g);
  }

  els.track.innerHTML = items.map(g => `
    <div class="item">
      <div class="itemEmoji">${renderIcon(g.iconKey)}</div>
      <div class="itemName">${escapeHtml(g.name)}</div>
      <div class="itemCost">
        <img class="starImg" src="img/Star.png" alt="‚≠ê" onerror="this.style.display='none'">
        <span>${g.cost}</span>
      </div>
    </div>
  `).join("");

  els.track.style.transform = "translateX(0px)";
  els.track.dataset.repeats = String(repeats);
}

function getCurrentTranslateX(){
  const tr = getComputedStyle(els.track).transform;
  if (!tr || tr === "none") return 0;
  const m = tr.match(/matrix\(([^)]+)\)/);
  if (!m) return 0;
  const parts = m[1].split(",").map(x => Number(x.trim()));
  return parts[4] || 0;
}

function animate(ms, step){
  return new Promise((resolve) => {
    const start = performance.now();
    function frame(now){
      const t = clamp((now - start) / ms, 0, 1);
      step(t);
      if (t < 1) requestAnimationFrame(frame);
      else resolve();
    }
    requestAnimationFrame(frame);
  });
}

/* ==========================
   COOLDOWN 24H
========================== */
function getLastSpinMs(){
  const v = Number(localStorage.getItem(kLastSpin()));
  return Number.isFinite(v) ? v : 0;
}
function setLastSpinMs(ms){
  localStorage.setItem(kLastSpin(), String(ms));
}
function getCooldownLeftMs(){
  const last = getLastSpinMs();
  if (!last) return 0;
  const left = (last + COOLDOWN_MS) - nowMs();
  return Math.max(0, left);
}
function canSpinNow(){
  if (IS_ADMIN) return true; // ‚úÖ @RealZanT –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–æ–ª–ª
  return getCooldownLeftMs() <= 0;
}
function updateCooldownUI(){
  if (IS_ADMIN){
    els.cooldownBadge.textContent = "‚àû –†–æ–ª–ª";
    els.spinBtn.disabled = false;
    return;
  }
  const left = getCooldownLeftMs();
  if (left <= 0){
    els.cooldownBadge.textContent = "–î–æ—Å—Ç—É–ø–Ω–æ";
    els.spinBtn.disabled = false;
    return;
  }
  els.cooldownBadge.textContent = `–ß–µ—Ä–µ–∑ ${fmtTimeLeft(left)}`;
  els.spinBtn.disabled = true;
}
setInterval(updateCooldownUI, 500);

/* ==========================
   CASES
========================== */
function renderCases(){
  els.casesRow.innerHTML = CASES.map(c => `
    <div class="caseCard ${c.id === activeCase.id ? "active" : ""}" data-id="${c.id}">
      <div class="caseArt">${renderIcon(c.iconKey)}</div>
      <div class="caseInfo">
        <div class="caseName">${escapeHtml(c.name)}</div>
        <div class="priceLine">
          <img class="starImg" src="img/Star.png" alt="‚≠ê" onerror="this.style.display='none'">
          <span>${c.price}</span>
          <small>–∑–∞ —Å–ø–∏–Ω</small>
        </div>
      </div>
    </div>
  `).join("");

  [...els.casesRow.querySelectorAll(".caseCard")].forEach(card=>{
    card.addEventListener("click", ()=>{
      const id = card.dataset.id;
      const found = CASES.find(x=>x.id===id);
      if (!found) return;
      activeCase = found;
      renderCases();
      refreshRoulette();
    });
  });
}

function refreshRoulette(){
  els.caseBadge.textContent = `–ö–µ–π—Å: ${activeCase.name} ‚Ä¢ —Ü–µ–Ω–∞ ${activeCase.price}`;
  els.spinBtn.innerHTML = `–ò—Å–ø—ã—Ç–∞–π —É–¥–∞—á—É ‚Äî <span style="display:inline-flex;align-items:center;gap:6px;vertical-align:middle;">
    <img class="starImg" src="img/Star.png" alt="‚≠ê" onerror="this.style.display='none'">
    ${activeCase.price}
  </span>`;
  buildTrack(activeCase.gifts);
  els.resultText.textContent = "–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ";
  els.resultMeta.textContent = "";
  updateCooldownUI();
}

/* ==========================
   MODAL keep/sell
========================== */
function openModal(gift, caseObj){
  pendingGift = { gift, caseObj };

  const sellValue = Math.max(1, Math.floor((gift.cost || 0) * SELL_RATE));
  els.modalEmoji.innerHTML = renderIcon(gift.iconKey);
  els.modalName.textContent = gift.name || "–ü–æ–¥–∞—Ä–æ–∫";
  els.modalInfo.textContent = `–ò–∑ –∫–µ–π—Å–∞: ${caseObj.name} ‚Ä¢ –ü—Ä–æ–¥–∞–∂–∞: ${Math.round(SELL_RATE*100)}% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏`;
  els.modalCost.textContent = String(gift.cost || 0);
  els.modalSell.textContent = String(sellValue);

  els.modalBack.style.display = "flex";
}
function closeModal(){
  els.modalBack.style.display = "none";
  pendingGift = null;
}
els.modalClose.addEventListener("click", closeModal);
els.modalBack.addEventListener("click", (e)=>{
  if (e.target === els.modalBack) closeModal();
});

/* ==========================
   INVENTORY
========================== */
function addToInventory(gift, caseObj){
  const item = {
    uid: "inv_" + Math.random().toString(16).slice(2) + "_" + Date.now(),
    giftId: gift.id || "",
    iconKey: gift.iconKey || "",
    name: gift.name || "–ü–æ–¥–∞—Ä–æ–∫",
    cost: Number(gift.cost || 0),
    fromCase: caseObj.name || "",
    ts: nowMs(),
  };
  inventory.unshift(item);
  saveInventory();
}
function sellItemValue(cost){
  return Math.max(1, Math.floor((Number(cost)||0) * SELL_RATE));
}
function renderInventory(){
  if (!inventory.length){
    els.invWrap.innerHTML = `<div class="empty">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç. –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ–π –ø–æ–¥–∞—Ä–æ–∫ –∏ –Ω–∞–∂–º–∏ ‚Äú–û—Å—Ç–∞–≤–∏—Ç—å‚Äù.</div>`;
    return;
  }

  els.invWrap.innerHTML = `
    <div class="invList">
      ${inventory.map(it => `
        <div class="invItem" data-uid="${escapeHtml(it.uid)}">
          <div class="invLeft">
            <div class="miniEmoji">${renderIcon(it.iconKey)}</div>
            <div style="min-width:0;">
              <div class="invName">${escapeHtml(it.name)}</div>
              <div class="invMeta">–ò–∑: ${escapeHtml(it.fromCase)} ‚Ä¢ ${new Date(it.ts).toLocaleString()}</div>
            </div>
          </div>

          <div class="invRight">
            <div class="smallPrice" title="–°—Ç–æ–∏–º–æ—Å—Ç—å">
              <img class="starImg" src="img/Star.png" alt="‚≠ê" onerror="this.style.display='none'">
              <span>${it.cost}</span>
            </div>
            <div class="smallPrice" title="–ü—Ä–æ–¥–∞–∂–∞">
              <img class="starImg" src="img/Star.png" alt="‚≠ê" onerror="this.style.display='none'">
              <span>${sellItemValue(it.cost)}</span>
            </div>
            <button class="btn" data-sell="${escapeHtml(it.uid)}">–ü—Ä–æ–¥–∞—Ç—å</button>
          </div>
        </div>
      `).join("")}
    </div>
  `;

  els.invWrap.querySelectorAll("button[data-sell]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const uid = btn.getAttribute("data-sell");
      const idx = inventory.findIndex(x=>x.uid===uid);
      if (idx < 0) return;
      const it = inventory[idx];
      const gain = sellItemValue(it.cost);

      inventory.splice(idx, 1);
      saveInventory();

      stars += gain;
      saveBalance();
      updateStarsUI();
      addEarned(gain);

      renderInventory();
      alert(`–ü—Ä–æ–¥–∞–Ω–æ: +${gain} ‚≠ê`);
    });
  });
}

/* ==========================
   SPIN
========================== */
async function spin({demo=false} = {}){
  if (isSpinning) return;

  const adminFree = IS_ADMIN && !demo;

  if (!demo && !adminFree){
    if (!canSpinNow()){
      updateCooldownUI();
      return;
    }
    const price = Number(activeCase.price) || 0;
    if (stars < price){
      els.resultText.textContent = "–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∑–≤—ë–∑–¥";
      els.resultMeta.textContent = `–ù—É–∂–Ω–æ: ${price}`;
      return;
    }
  }

  isSpinning = true;
  els.spinBtn.disabled = true;
  els.demoBtn.disabled = true;

  if (!demo && !adminFree){
    const price = Number(activeCase.price) || 0;
    stars = stars - price;
    saveBalance();
    updateStarsUI();
  }

  const base = activeCase.gifts;
  const picked = weightedPick(base);
  const baseIndex = picked.index;

  const repeats = Number(els.track.dataset.repeats || 18);
  const targetRepeat = repeats - 3;
  const targetIndexLong = targetRepeat * base.length + baseIndex;

  const rect = els.window.getBoundingClientRect();
  const centerX = rect.width / 2;

  const ITEM_W = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--itemW')) || 150;
  const itemCenterX = targetIndexLong * ITEM_W + ITEM_W / 2;
  const targetTranslate = centerX - itemCenterX;

  const from = getCurrentTranslateX();
  const duration = 2400 + Math.random()*700;
  const jitter = (Math.random()*12) - 6;
  const finalTranslate = targetTranslate + jitter;

  await animate(duration, (t)=>{
    const eased = easeOutCubic(t);
    const x = from + (finalTranslate - from) * eased;
    els.track.style.transform = `translateX(${x}px)`;
  });

  els.track.style.transform = `translateX(${targetTranslate}px)`;

  els.resultText.textContent = `${picked.gift.name}`;
  els.resultMeta.textContent = demo ? "–¥–µ–º–æ" : (adminFree ? "–∞–¥–º–∏–Ω" : "—Å–ø–∏–Ω");

  if (!demo && !adminFree){
    setLastSpinMs(nowMs());
    updateCooldownUI();
  } else {
    updateCooldownUI();
  }

  // ‚úÖ –µ—Å–ª–∏ –≤—ã–ø–∞–ª–∏ –∑–≤—ë–∑–¥—ã ‚Äî —Å—Ä–∞–∑—É –Ω–∞—á–∏—Å–ª—è–µ–º (2‚≠ê –∏ —Ç.–¥.)
  if (!demo && picked.gift && picked.gift.isStars){
    const gain = Math.max(1, Number(picked.gift.cost || 0));
    stars += gain;
    saveBalance();
    updateStarsUI();
    addEarned(gain);
    alert(`–í—ã–∏–≥—Ä—ã—à: +${gain} ‚≠ê`);
  } else if (!demo) {
    openModal(picked.gift, activeCase);
  }

  isSpinning = false;
  els.demoBtn.disabled = false;
}

/* buttons */
els.spinBtn.addEventListener("click", ()=> spin({demo:false}));
els.demoBtn.addEventListener("click", ()=> spin({demo:true}));

// admin +
els.addStarsBtn.addEventListener("click", ()=>{
  if (!IS_ADMIN){
    alert("–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.");
    return;
  }
  const v = prompt("–°–∫–æ–ª—å–∫–æ –∑–≤—ë–∑–¥ –¥–æ–±–∞–≤–∏—Ç—å? (–∞–¥–º–∏–Ω)", "40");
  if (v === null) return;
  const n = Math.floor(Number(v));
  if (!Number.isFinite(n) || n <= 0) return;
  stars += n;
  saveBalance();
  updateStarsUI();
});

/* modal actions */
els.keepBtn.addEventListener("click", ()=>{
  if (!pendingGift) return;
  addToInventory(pendingGift.gift, pendingGift.caseObj);
  closeModal();
  alert("–ü–æ–¥–∞—Ä–æ–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚úÖ");
});
els.sellBtn.addEventListener("click", ()=>{
  if (!pendingGift) return;
  const gain = Math.max(1, Math.floor((pendingGift.gift.cost || 0) * SELL_RATE));
  stars += gain;
  saveBalance();
  updateStarsUI();
  addEarned(gain);
  closeModal();
  alert(`–ü—Ä–æ–¥–∞–Ω–æ: +${gain} ‚≠ê`);
});

/* export */
els.exportBtn.addEventListener("click", ()=>{
  const data = {
    user: USER,
    stars,
    earned,
    inventory,
    lastSpinMs: getLastSpinMs(),
    exportedAt: new Date().toISOString()
  };
  const txt = JSON.stringify(data, null, 2);
  prompt("–°–∫–æ–ø–∏—Ä—É–π —ç–∫—Å–ø–æ—Ä—Ç JSON:", txt);
});

/* wipe */
els.wipeBtn.addEventListener("click", ()=>{
  const ok = confirm("–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å? (–ª–æ–∫–∞–ª—å–Ω–æ)");
  if (!ok) return;
  localStorage.removeItem(kBalance());
  localStorage.removeItem(kInv());
  localStorage.removeItem(kLastSpin());
  localStorage.removeItem(kEarned());
  loadAll();
  renderInventory();
  updateCooldownUI();
  alert("–°–±—Ä–æ—à–µ–Ω–æ.");
});

/* admin panel */
if (els.adminAdd100){
  els.adminAdd100.addEventListener("click", ()=>{
    if (!IS_ADMIN) return;
    stars += 100;
    saveBalance();
    updateStarsUI();
    alert("+100 ‚≠ê");
  });
}
if (els.adminResetCd){
  els.adminResetCd.addEventListener("click", ()=>{
    if (!IS_ADMIN) return;
    setLastSpinMs(0);
    updateCooldownUI();
    alert("–ö–î —Å–±—Ä–æ—à–µ–Ω ‚úÖ");
  });
}

/* ==========================
   INIT
========================== */
initUser();
loadAll();
renderCases();
refreshRoulette();
updateCooldownUI();
renderInventory();

</script>
</body>
</html>
